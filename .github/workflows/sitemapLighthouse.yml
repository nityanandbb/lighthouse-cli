name: "â›³ï¸ ğŸ—ºï¸ ğŸš€ Sitemap Lighthouse (Sitemap-only)"

on:
  workflow_dispatch:
    inputs:
      # 1
      baseUrl:
        description: "ğŸŒ Base URL (required). Example: https://www.example.com"
        default: ""
        required: true

      # 2  (descriptive labels; we parse the leading number at runtime)
      sitemapMode:
        description: "ğŸ—ºï¸ Choose sitemap mode"
        type: choice
        options:
          - "1 â€” Sample (global sitemap) â€” e.g. auto-pick from /sitemap.xml, preset 50x5"
          - "2 â€” Only subpath (starts with) â€” e.g. /services/ /products/"
          - "3 â€” StartWith + Contains â€” e.g. start: /en/  contains: careers insights"
          - "4 â€” Contains + Contains â€” e.g. contains: products  AND contains: pricing"
          - "5 â€” Contains OR â€” e.g. contains any: blog careers jobs"
          - "6 â€” Multi-domain â€” e.g. example.com site2.com"
        default: "1 â€” Sample (global sitemap) â€” e.g. auto-pick from /sitemap.xml, preset 50x5"
        required: true

      # 3  (NxG where N=URLs per group, G=#groups cap)
      sitemapPreset:
        description: |
          ğŸ§© Sample preset â€” NxG (N = URLs per group, G = #groups cap).
          Example: 30x2 â‡’ take up to 30 from each of 2 groups â‡’ ~60 total.
        type: choice
        options: ["30x1","50x1","100x2","200x4","500x5","1000x10","custom"]
        default: "30x1"
        required: true

      # 4  (shown regardless; GitHub can't conditionally show)
      customSample:
        description: "âœï¸ If preset = 'custom': enter NxG (e.g., 75x5). N=per group, G=#groups."
        default: "50x5"
        required: false

      # 5
      startWith:
        description: "â†˜ï¸ PATH starts with (OR). e.g. /en/ /services/ (Modes 2 & 3)"
        default: ""

      # 6
      containsAny:
        description: "ğŸ” PATH contains ANY (OR). e.g. insights careers products (Modes 3 & 5)"
        default: ""

      # ---- Project meta (keep within 10-input cap) ----
      # 7
      projectName:
        description: "ğŸ“¦ Project Name"
        default: "Internal"
      # 8
      client:
        description: "ğŸ‘¤ Client Name"
        default: "Internal"
      # 9
      projectManager:
        description: "ğŸ§‘â€ğŸ’¼ Project Manager"
        default: "Kunal"
      # 10
      qaManager:
        description: "ğŸ§ª QA Manager"
        default: "Archana"

jobs:
  sitemap-run:
    runs-on: ubuntu-22.04

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}   # secret injected
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "^18.3 || ^20.18.1"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ§ª Validate Inputs & Export Env
        shell: bash
        run: |
          set -euo pipefail
          BLUE="\033[1;34m"; GREEN="\033[1;32m"; RED="\033[1;31m"; YELLOW="\033[1;33m"; NC="\033[0m"
          echo -e "${BLUE}ğŸ” Validating Inputs...${NC}"

          baseUrl="${{ github.event.inputs.baseUrl }}"
          sitemapMode="${{ github.event.inputs.sitemapMode }}"
          sitemapPreset="${{ github.event.inputs.sitemapPreset }}"
          customSample="${{ github.event.inputs.customSample }}"
          startWith="${{ github.event.inputs.startWith }}"
          containsAny="${{ github.event.inputs.containsAny }}"

          projectName="${{ github.event.inputs.projectName }}"
          client="${{ github.event.inputs.client }}"
          projectManager="${{ github.event.inputs.projectManager }}"
          qaManager="${{ github.event.inputs.qaManager }}"

          # Required: baseUrl
          if [[ -z "$baseUrl" ]]; then
            echo -e "${RED}âŒ Input error:${NC} baseUrl is required (e.g., https://www.example.com)"
            exit 1
          fi

          # Parse leading number from descriptive mode option (e.g., "1 â€” Sample ...")
          MODE_NUM=""
          if [[ "$sitemapMode" =~ ^[[:space:]]*([0-9]+) ]]; then
            MODE_NUM="${BASH_REMATCH[1]}"
          else
            echo -e "${RED}âŒ Input error:${NC} sitemapMode must start with a number 1..6"
            exit 1
          fi

          # Keep your previous behavior: MODE fixed to 1 for sitemap-only runner
          MODE="1"

          # Resolve NxG (N=URLs per group, G=#groups cap)
          SAMPLE_STR="$sitemapPreset"
          if [[ "$sitemapPreset" == "custom" ]]; then
            SAMPLE_STR="$customSample"
          fi

          # Accept "100 X 2", "100x2", "  100  x  2 "
          if [[ ! "$SAMPLE_STR" =~ ^[[:space:]]*[0-9]+[[:space:]]*[xX][[:space:]]*[0-9]+[[:space:]]*$ ]]; then
            echo -e "${RED}âŒ Invalid NxG format:${NC} '$SAMPLE_STR'  Use e.g., 75x5"
            exit 1
          fi

          NORM="$(echo "$SAMPLE_STR" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"
          MAX_PER_GROUP="${NORM%x*}"
          MAX_GROUPS="${NORM#*x}"
          if (( MAX_PER_GROUP < 1 || MAX_GROUPS < 1 )); then
            echo -e "${RED}âŒ NxG numbers must be >= 1${NC}"
            exit 1
          fi
          MAX_TOTAL=$(( MAX_PER_GROUP * MAX_GROUPS ))

          {
            echo "BASE_URL=$baseUrl"
            echo "SITEMAP_MODE_LABEL=$sitemapMode"
            echo "SITEMAP_MODE_NUM=$MODE_NUM"
            echo "MODE=$MODE"

            echo "SITEMAP_PRESET=$sitemapPreset"
            echo "CUSTOM_SAMPLE=$customSample"
            echo "MAX_PER_GROUP=$MAX_PER_GROUP"
            echo "MAX_GROUPS=$MAX_GROUPS"
            echo "MAX_TOTAL=$MAX_TOTAL"

            echo "START_WITH=$startWith"
            echo "CONTAINS_ANY=$containsAny"

            # Defaults (unchanged)
            echo "CONTAINS_ALL="
            echo "INCLUDE_RE="
            echo "EXCLUDE_RE="
            echo "ALLOW_SUBDOMAINS=false"
            echo "ALLOW_HOSTS="
            echo "HOST_RE="
            echo "SKIP_VALIDATE=false"
            echo "CONCURRENCY=8"
            echo "MAX_SITEMAPS=1000"

            echo "PROJECT_NAME=$projectName"
            echo "CLIENT=$client"
            echo "PROJECT_MANAGER=$projectManager"
            echo "QA_MANAGER=$qaManager"
            echo "EXPECTED_LOAD_TIME=3 seconds"
          } >> "$GITHUB_ENV"

          echo -e "${GREEN}âœ… Inputs OK${NC}"
          echo -e "${YELLOW}â„¹ï¸ Summary:${NC} ğŸŒ baseUrl=$baseUrl | ğŸ—ºï¸ mode='$sitemapMode' (num=$MODE_NUM)"
          echo -e "   ğŸ§© preset=$sitemapPreset â†’ ${MAX_PER_GROUP}/group Ã— ${MAX_GROUPS} groups â‰ˆ cap ${MAX_TOTAL}"
          echo -e "   â†˜ï¸ startWith='${startWith}' | ğŸ” containsAny='${containsAny}'"
          echo -e "   ğŸ“¦ $projectName | ğŸ‘¤ $client | ğŸ§‘â€ğŸ’¼ $projectManager | ğŸ§ª $qaManager"

      - name: ğŸ”§ Prepare URL List (Sitemap)
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;34mğŸ”§ Building URL list from sitemap...\033[0m"
          node core/sitemapUrlBuilder.js
          if test -f "TestURL.js"; then
            echo -e "\033[1;32mâœ… TestURL.js ready\033[0m"
          else
            echo -e "\033[1;31mâŒ TestURL.js missing\033[0m"
            exit 1
          fi

      - name: â³ Wait 10s after URL file creation
        run: |
          echo -e "\033[1;33mâŒ› Waiting 10 seconds to ensure file watchers/processors catch TestURL.js...\033[0m"
          sleep 10

      - name: ğŸš€ Run Lighthouse Tests
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;36mğŸ“¡ Starting Lighthouse...\033[0m"
          node runLighthouseAuto.js
          echo -e "\033[1;32mâœ… Lighthouse complete.\033[0m"

      - name: â³ Wait for Reports
        run: |
          echo -e "âŒ› Sleeping 40s to allow report generation..."
          sleep 40

      - name: ğŸ“‚ Move Reports to Reports_QA
        run: |
          mkdir -p ./Reports_QA
          mv *.html ./Reports_QA/ 2>/dev/null || true
          mv *.pdf ./Reports_QA/ 2>/dev/null || true
          mv ./results/*.csv ./Reports_QA/ 2>/dev/null || true
          echo -e "\033[1;32mâœ… Reports moved to Reports_QA\033[0m"

      - name: ğŸ“¤ Upload Reports as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sitemap-lighthouse-reports
          path: ./Reports_QA/*

      - name: ğŸ“¦ Upload Lighthouse Full Results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-full-results
          path: ./.lighthouseci/*
