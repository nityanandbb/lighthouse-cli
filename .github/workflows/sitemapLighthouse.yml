name: "‚õ≥Ô∏è üó∫Ô∏è üöÄ Sitemap Lighthouse (Sitemap-only)"

on:
  workflow_dispatch:
    inputs:
      # 1
      baseUrl:
        description: "üåê Base URL (required). Example: https://www.example.com"
        default: ""
        required: true

      # 2
      sitemapMode:
        description: |
          üó∫Ô∏è Sitemap mode (choose a number):
          1 ‚Üí Sample ‚Äî Selects URLs directly from the global sitemap (quick check; sampling applies).
          2 ‚Üí Only subpath ‚Äî Include URLs that START WITH given paths. Ex: /products/ /services/
          3 ‚Üí StartWith+Contains ‚Äî Must START WITH given path AND CONTAIN any keywords.
          4 ‚Üí Contains+Contains ‚Äî Must CONTAIN keywords from two lists (AND logic across lists).
          5 ‚Üí Contains OR ‚Äî Must CONTAIN ANY of the keywords (OR logic).
          6 ‚Üí Multi-domain ‚Äî Crawl multiple domains' sitemaps and unify results.
        type: choice
        options: ["1","2","3","4","5","6"]
        default: "1"
        required: true

      # 3
      sitemapPreset:
        description: |
          üß© Sample preset
          Format NxG ‚Üí N = total URL cap, G = per‚Äëgroup cap (groups = path buckets like /products/, /careers/, /en/).
          Examples: 50x5 ‚áí up to 50 URLs total, max 5 from each group. 200x10 ‚áí up to 200 total, max 10/group.
          If you choose 'custom', we fallback to 100x10 here (kept simple to stay within 10-input limit).
        type: choice
        options: ["50x5","200x10","custom"]
        default: "50x5"

      # 4
      startWith:
        description: "‚ÜòÔ∏è PATH starts with (OR). e.g. /en/ /services/ (Modes 2 & 3)"
        default: ""

      # 5
      containsAny:
        description: "üîé PATH contains ANY (OR). e.g. insights careers products (Modes 3 & 5)"
        default: ""

      # 6
      exclude:
        description: "üö´ Exclude prefixes. e.g. /blog/ /news/"
        default: ""

      # ---- Project meta (4 inputs to stay within the 10-input cap) ----
      # 7
      projectName:
        description: "üì¶ Project Name"
        default: "Internal"
      # 8
      client:
        description: "üë§ Client Name"
        default: "Internal"
      # 9
      projectManager:
        description: "üßë‚Äçüíº Project Manager"
        default: "Kunal"
      # 10
      qaManager:
        description: "üß™ QA Manager"
        default: "Archana"

jobs:
  sitemap-run:
    runs-on: ubuntu-22.04

    steps:
      - name: ‚¨áÔ∏è Checkout Code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "^18.3 || ^20.18.1"

      - name: üì¶ Install Dependencies 
        run: npm install

      - name: üß™ Validate Inputs & Export Env
        shell: bash
        run: |
          set -euo pipefail
          BLUE="\033[1;34m"; GREEN="\033[1;32m"; RED="\033[1;31m"; YELLOW="\033[1;33m"; NC="\033[0m"
          echo -e "${BLUE}üîç Validating Inputs...${NC}"

          baseUrl="${{ github.event.inputs.baseUrl }}"
          sitemapMode="${{ github.event.inputs.sitemapMode }}"
          sitemapPreset="${{ github.event.inputs.sitemapPreset }}"
          startWith="${{ github.event.inputs.startWith }}"
          containsAny="${{ github.event.inputs.containsAny }}"
          exclude="${{ github.event.inputs.exclude }}"

          projectName="${{ github.event.inputs.projectName }}"
          client="${{ github.event.inputs.client }}"
          projectManager="${{ github.event.inputs.projectManager }}"
          qaManager="${{ github.event.inputs.qaManager }}"

          # Required
          if [[ -z "$baseUrl" ]]; then
            echo -e "${RED}‚ùå Input error:${NC} baseUrl is required (e.g., https://www.example.com)"
            exit 1
          fi

          # MODE is always 1 for sitemap workflow (kept as-is)
          MODE="1"
          echo "MODE=$MODE" >> "$GITHUB_ENV"

          # Sitemap preset ‚Üí caps (kept as-is, with clear colored logs)
          case "$sitemapPreset" in
            "50x5")   TARGET_TOTAL=50;  PER_GROUP=5  ;;
            "200x10") TARGET_TOTAL=200; PER_GROUP=10 ;;
            "custom") TARGET_TOTAL=100; PER_GROUP=10 ;;  # fallback numbers (kept simple to meet 10-input limit)
            *) echo -e "${RED}‚ùå Invalid sitemapPreset:${NC} '$sitemapPreset'"; exit 1 ;;
          esac

          {
            echo "BASE_URL=$baseUrl"
            echo "SITEMAP_MODE=$sitemapMode"
            echo "SITEMAP_PRESET=$sitemapPreset"
            echo "TARGET_TOTAL=$TARGET_TOTAL"
            echo "PER_GROUP=$PER_GROUP"

            # Filters (kept to 3 most-used to fit 10-input cap)
            echo "START_WITH=$startWith"
            echo "CONTAINS_ANY=$containsAny"
            echo "EXCLUDE=$exclude"

            # Reasonable defaults (you can edit these constants if needed)
            echo "CONTAINS_ALL="              # intentionally omitted to stay under 10 inputs
            echo "INCLUDE_RE="
            echo "EXCLUDE_RE="
            echo "ALLOW_SUBDOMAINS=false"
            echo "ALLOW_HOSTS="
            echo "HOST_RE="
            echo "SKIP_VALIDATE=false"
            echo "CONCURRENCY=8"
            echo "MAX_SITEMAPS=1000"

            # Project meta (Expected Load Time defaulted here to keep inputs <= 10)
            echo "PROJECT_NAME=$projectName"
            echo "CLIENT=$client"
            echo "PROJECT_MANAGER=$projectManager"
            echo "QA_MANAGER=$qaManager"
            echo "EXPECTED_LOAD_TIME=3 seconds"
          } >> "$GITHUB_ENV"

          echo -e "${GREEN}‚úÖ Inputs OK${NC}"
          echo -e "${YELLOW}‚ÑπÔ∏è  Summary:${NC} üåê baseUrl=$baseUrl | üó∫Ô∏è mode=$sitemapMode | üß© preset=$sitemapPreset"
          echo -e "   ‚ÜòÔ∏è startWith='${startWith}' | üîé containsAny='${containsAny}' | üö´ exclude='${exclude}'"
          echo -e "   üì¶ $projectName | üë§ $client | üßë‚Äçüíº $projectManager | üß™ $qaManager"

      - name: üîß Prepare URL List (Sitemap)
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;34müîß Building URL list from sitemap...\033[0m"
          node core/sitemapUrlBuilder.js
          if test -f "TestURL.js"; then
            echo -e "\033[1;32m‚úÖ TestURL.js ready\033[0m"
          else
            echo -e "\033[1;31m‚ùå TestURL.js missing\033[0m"
            exit 1
          fi

      - name: ‚è≥ Wait 10s after URL file creation
        run: |
          echo -e "\033[1;33m‚åõ Waiting 10 seconds to ensure file watchers/processors catch TestURL.js...\033[0m"
          sleep 10

      - name: üöÄ Run Lighthouse Tests
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;36müì° Starting Lighthouse...\033[0m"
          node runLighthouseAuto.js
          echo -e "\033[1;32m‚úÖ Lighthouse complete.\033[0m"

      - name: ‚è≥ Wait for Reports
        run: |
          echo -e "‚åõ Sleeping 40s to allow report generation..."
          sleep 40

      - name: üìÇ Move Reports to Reports_QA
        run: |
          mkdir -p ./Reports_QA
          mv *.html ./Reports_QA/ 2>/dev/null || true
          mv *.pdf ./Reports_QA/ 2>/dev/null || true
          mv ./results/*.csv ./Reports_QA/ 2>/dev/null || true
          echo -e "\033[1;32m‚úÖ Reports moved to Reports_QA\033[0m"

      - name: üì§ Upload Reports as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sitemap-lighthouse-reports
          path: ./Reports_QA/*

      - name: üì¶ Upload Lighthouse Full Results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-full-results
          path: ./.lighthouseci/*
