name: "ðŸš€ AI + Lighthouse Audit CLI Workflow"

on:
  workflow_dispatch:
    inputs:
      aiAnalysis:
        description: "ðŸ§  Enable AI Analysis? (yes / no)"
        required: true
        default: "no"
      mode:
        description: |
          ðŸŽ¯ Select Test Mode:
          1: Auto Extract (Hover + Heuristics)
          2: CSS Selector
          3: XPath Selector
          4: Raw URL List
          5: All Anchor Tags
        required: true
        default: "1"
      baseUrl:
        description: "ðŸŒ Base URL (Required for modes 1, 2, 3, 5)"
        required: false
      selector:
        description: "ðŸŽ¯ CSS or XPath selector (Required for mode 2 and 3)"
        required: false
      rawInput:
        description: "ðŸ“„ Raw space-separated URLs (Required for mode 4)"
        required: false
      projectName:
        description: "ðŸ“¦ Project Name"
        required: false
        default: "Internal"
      client:
        description: "ðŸ‘¤ Client Name"
        required: false
        default: "Internal"
      projectManager:
        description: "ðŸ§‘â€ðŸ’¼ Project Manager"
        required: false
        default: "Kunal"
      qaManager:
        description: "ðŸ§ª QA Manager"
        required: false
        default: "Archana"
      expectedLoadTime:
        description: "â±ï¸ Expected Load Time (e.g., '3 seconds')"
        required: false
        default: "3 seconds"

jobs:
  setup-and-execute:
    runs-on: ubuntu-22.04

    steps:
    - name: â¬‡ï¸ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "^18.3 || ^20.18.1"

    - name: ðŸ“¦ Install Dependencies
      run: npm install

    - name: ðŸ§ª Validate Inputs & Export Env
      run: |
        echo "âœ… Validating Inputs..."

        # Convert AI analysis input to boolean
        ai="${{ github.event.inputs.aiAnalysis }}"
        if [[ "$ai" == "yes" ]]; then
          echo "AI_ANALYSIS=true" >> $GITHUB_ENV
        else
          echo "AI_ANALYSIS=false" >> $GITHUB_ENV
        fi

        mode="${{ github.event.inputs.mode }}"
        baseUrl="${{ github.event.inputs.baseUrl }}"
        selector="${{ github.event.inputs.selector }}"
        rawInput="${{ github.event.inputs.rawInput }}"

        # Validate mode
        if ! [[ "$mode" =~ ^[1-5]$ ]]; then
          echo "âŒ Invalid mode selected. Must be 1, 2, 3, 4, or 5."
          exit 1
        fi

        # Validate required inputs per mode
        if [[ "$mode" == "1" || "$mode" == "2" || "$mode" == "3" || "$mode" == "5" ]]; then
          if [ -z "$baseUrl" ]; then
            echo "âŒ baseUrl is required for mode $mode."
            exit 1
          fi
        fi

        if [[ "$mode" == "2" || "$mode" == "3" ]]; then
          if [ -z "$selector" ]; then
            echo "âŒ selector is required for mode $mode."
            exit 1
          fi
        fi

        if [[ "$mode" == "4" && -z "$rawInput" ]]; then
          echo "âŒ rawInput is required for mode 4."
          exit 1
        fi

        # Export inputs
        echo "MODE=$mode" >> $GITHUB_ENV
        echo "BASE_URL=$baseUrl" >> $GITHUB_ENV
        echo "SELECTOR=$selector" >> $GITHUB_ENV
        echo "RAW_INPUT=$rawInput" >> $GITHUB_ENV

        echo "PROJECT_NAME=${{ github.event.inputs.projectName }}" >> $GITHUB_ENV
        echo "CLIENT=${{ github.event.inputs.client }}" >> $GITHUB_ENV
        echo "PROJECT_MANAGER=${{ github.event.inputs.projectManager }}" >> $GITHUB_ENV
        echo "QA_MANAGER=${{ github.event.inputs.qaManager }}" >> $GITHUB_ENV
        echo "EXPECTED_LOAD_TIME=${{ github.event.inputs.expectedLoadTime }}" >> $GITHUB_ENV

        echo "âœ… Inputs validated and exported successfully!"
        echo "-------------------------------------------"
        echo "ðŸ“¦ Mode: $mode"
        echo "ðŸŒ Base URL: $baseUrl"
        echo "ðŸ”Ž Selector: $selector"
        echo "ðŸ“„ Raw Input: $rawInput"
        echo "ðŸ§  AI Analysis: $ai"
        echo "-------------------------------------------"

    - name: ðŸƒðŸ¼ Run URL Extraction
      run: |
        echo "ðŸ§ª Starting mode $MODE test extraction..."
        node run.js

    - name: ðŸš€ Run Lighthouse Tests
      run: |
        echo "ðŸ“¡ Starting Lighthouse audit..."
        node executeGithub.js
        echo "âœ… Lighthouse audit complete."

    - name: â³ Wait for Reports
      run: |
        echo "âŒ› Sleeping 40s to allow report generation..."
        sleep 40

    - name: ðŸ“‚ Move Reports to Reports_QA
      run: |
        mkdir -p ./Reports_QA
        mv *.html ./Reports_QA/ 2>/dev/null || true
        mv *.pdf ./Reports_QA/ 2>/dev/null || true
        mv ./results/*.csv ./Reports_QA/ 2>/dev/null || true
        echo "âœ… Reports moved to Reports_QA"

    - name: ðŸ“¤ Upload Reports as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-csv-html-reports
        path: ./Reports_QA/*

    - name: ðŸ“¦ Upload Lighthouse Full Results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-full-results
        path: ./.lighthouseci/*
