name: "ðŸš€ AI + Lighthouse Audit CLI Workflow"

on:
  workflow_dispatch:
    inputs:
      aiAnalysis:
        description: "ðŸ§  Enable AI Analysis? (yes / no)"
        required: true
        default: "no"
      mode:
        description: |
          ðŸŽ¯ Select Test Mode:
          1: Auto Extract (Hover + Heuristics)
          2: CSS Selector
          3: XPath Selector
          4: Raw URL List
          5: All Anchor Tags
        required: true
        default: "1"
      baseUrl:
        description: "ðŸŒ Base URL (Required for modes 1, 2, 3, 5)" 
        required: false
      selector:
        description: "ðŸŽ¯ CSS or XPath selector (Required for mode 2 and 3)"
        required: false
      rawInput:
        description: "ðŸ“„ Raw space-separated URLs (Required for mode 4)"
        required: false
      projectName:
        description: "ðŸ“¦ Project Name"
        required: false
        default: "Internal"
      client:
        description: "ðŸ‘¤ Client Name"
        required: false
        default: "Internal"
      projectManager:
        description: "ðŸ§‘â€ðŸ’¼ Project Manager"
        required: false
        default: "Kunal"
      qaManager:
        description: "ðŸ§ª QA Manager"
        required: false
        default: "Archana"
      expectedLoadTime:
        description: "â±ï¸ Expected Load Time (e.g., '3 seconds')"
        required: false
        default: "3 seconds"

jobs:
  setup-and-execute:
    runs-on: ubuntu-22.04

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "^18.3 || ^20.18.1"

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ“¦ Install Puppeteer for dynamic modes (1/2/3/5)
        if: ${{ env.MODE != '4' }}
        run: npm install puppeteer

      - name: ðŸ§ª Validate Inputs & Export Env
        run: |
          echo -e "\033[1;34mðŸ” Validating Inputs...\033[0m"
          ai="${{ github.event.inputs.aiAnalysis }}"
          mode="${{ github.event.inputs.mode }}"
          baseUrl="${{ github.event.inputs.baseUrl }}"
          selector="${{ github.event.inputs.selector }}"
          rawInput="${{ github.event.inputs.rawInput }}"

          # Validate AI toggle
          if [[ "$ai" == "yes" ]]; then
            echo "AI_ANALYSIS=true" >> $GITHUB_ENV
          else
            echo "AI_ANALYSIS=false" >> $GITHUB_ENV
          fi

          # Validate mode
          if ! [[ "$mode" =~ ^[1-5]$ ]]; then
            echo -e "\033[0;31mâŒ Invalid mode selected: $mode. Must be 1â€“5.\033[0m"
            exit 1
          fi

          # Mode-specific validation
          if [[ "$mode" =~ ^[1|2|3|5]$ && -z "$baseUrl" ]]; then
            echo -e "\033[0;31mâŒ baseUrl is required for mode $mode.\033[0m"
            exit 1
          fi
          if [[ "$mode" =~ ^[2|3]$ && -z "$selector" ]]; then
            echo -e "\033[0;31mâŒ selector is required for mode $mode.\033[0m"
            exit 1
          fi
          if [[ "$mode" == "4" && -z "$rawInput" ]]; then
            echo -e "\033[0;31mâŒ rawInput is required for mode 4.\033[0m"
            exit 1
          fi

          # Export variables
          echo "MODE=$mode" >> $GITHUB_ENV
          echo "BASE_URL=$baseUrl" >> $GITHUB_ENV
          echo "SELECTOR=$selector" >> $GITHUB_ENV
          echo "RAW_INPUT=$rawInput" >> $GITHUB_ENV
          echo "PROJECT_NAME=${{ github.event.inputs.projectName }}" >> $GITHUB_ENV
          echo "CLIENT=${{ github.event.inputs.client }}" >> $GITHUB_ENV
          echo "PROJECT_MANAGER=${{ github.event.inputs.projectManager }}" >> $GITHUB_ENV
          echo "QA_MANAGER=${{ github.event.inputs.qaManager }}" >> $GITHUB_ENV
          echo "EXPECTED_LOAD_TIME=${{ github.event.inputs.expectedLoadTime }}" >> $GITHUB_ENV

          echo -e "\033[1;32mâœ… All inputs validated and exported.\033[0m"
          echo "------------------------------------------"
          echo "ðŸŽ¯ Mode: $mode"
          echo "ðŸŒ Base URL: $baseUrl"
          echo "ðŸ”Ž Selector: $selector"
          echo "ðŸ“„ Raw Input: $rawInput"
          echo "ðŸ§  AI Analysis: $ai"
          echo "------------------------------------------"

      - name: ðŸ”§ Prepare URL List
        run: |
          echo -e "\033[1;34mðŸ”§ Building URL list...\033[0m"
          if [[ "$MODE" == "4" ]]; then
            echo "$RAW_INPUT" | tr ' ' '\n' > urlList.txt
          else
            node core/githubTestUrlBuilder.js
            test -f TestURL.js && echo "âœ… TestURL.js found" || echo "âŒ TestURL.js missing"
          fi

  debug-testurl:
    needs: build-url-list
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§ª Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ§ª List files recursively
        run: |
          echo -e "\033[1;33mðŸ“‚ Searching for TestURL.js...\033[0m"
          find . -name "TestURL.js"
          
      - name: ðŸ§ª Tree view for debugging
        run: |
          echo -e "\033[1;36mðŸ“ Directory structure:\033[0m"
          tree -a -L 3 || true

      - name: ðŸš€ Run Lighthouse Tests
        run: |
          echo -e "\033[1;36mðŸ“¡ Starting Lighthouse audit...\033[0m"

          if [[ "$MODE" == "4" ]]; then
            echo -e "\033[1;33mðŸ”— Mode 4 selected â€” using rawInput via executeGithub.js...\033[0m"
            node executeGithub.js
          else
            echo -e "\033[1;34mðŸ§  Mode $MODE â€” using generated TestURL.js via runLighthouseAuto.js...\033[0m"
            node runLighthouseAuto.js
          fi

          echo -e "\033[1;32mâœ… Lighthouse audit complete.\033[0m"

      - name: â³ Wait for Reports
        run: |
          echo -e "âŒ› Sleeping 40s to allow report generation..."
          sleep 40

      - name: ðŸ“‚ Move Reports to Reports_QA
        run: |
          mkdir -p ./Reports_QA
          mv *.html ./Reports_QA/ 2>/dev/null || true
          mv *.pdf ./Reports_QA/ 2>/dev/null || true
          mv ./results/*.csv ./Reports_QA/ 2>/dev/null || true
          echo -e "\033[1;32mâœ… Reports moved to Reports_QA\033[0m"

      - name: ðŸ“¤ Upload Reports as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-csv-html-reports
          path: ./Reports_QA/*

      - name: ðŸ“¦ Upload Lighthouse Full Results 
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-full-results 
          path: ./.lighthouseci/*
 