name: " â›³ï¸ ðŸ—ºï¸ ðŸš€ Sitemap AI + Lighthouse Audit CLI"

on:
  workflow_dispatch:
    inputs:
      runType:
        description: "ðŸ§­ Pick Run Type"
        type: choice
        options:
          - sitemap
          - css
        default: sitemap
        required: true

      # Sitemap sub-modes (your recipes 1..6)
      sitemapMode:
        description: "ðŸ—ºï¸ Sitemap: 1=Sample, 2=Only one subpath, 3=StartWith+Includes, 4=Includes+Includes, 5=Includes OR, 6=Multi-domain"
        type: choice
        options: ["1","2","3","4","5","6"]
        default: "1"
        required: true

      # CSS/XPath sub-modes (your old 1..5)
      cssMode:
        description: "ðŸŽ¯ CSS/XPath: 1=Auto(anchors), 2=CSS, 3=XPath, 4=Raw list, 5=All anchors"
        type: choice
        options: ["1","2","3","4","5"]
        default: "2"
        required: true

      # Common fields
      baseUrl:
        description: "ðŸŒ Base URL (required for sitemap and css modes except raw)"
        default: ""
        required: false
      selector:
        description: "ðŸŽ¯ CSS or XPath selector (required for cssMode 2/3)"
        default: ""
        required: false
      rawInput:
        description: "ðŸ“„ Space-separated URLs (cssMode=4)"
        default: ""
        required: false

      # Project meta
      projectName:
        description: "ðŸ“¦ Project Name"
        default: "Internal"
      client:
        description: "ðŸ‘¤ Client Name"
        default: "Internal"
      projectManager:
        description: "ðŸ§‘â€ðŸ’¼ Project Manager"
        default: "Kunal"
      qaManager:
        description: "ðŸ§ª QA Manager"
        default: "Archana"
      expectedLoadTime:
        description: "â±ï¸ Expected Load Time"
        default: "3 seconds"

      # Sitemap knobs
      sitemapPreset:
        description: "ðŸ§© Preset (50x5, 200x10, or custom)"
        type: choice
        options: ["50x5","200x10","custom"]
        default: "50x5"
      targetTotal:
        description: "ðŸŽ¯ Custom target (preset=custom)"
        default: "50"
      perGroup:
        description: "ðŸ§± Custom per-group (preset=custom)"
        default: "5"
      startWith:
        description: "â†˜ï¸ PATH starts with (OR). e.g. /en/ /services/"
        default: ""
      containsAny:
        description: "ðŸ”Ž PATH contains ANY (OR). e.g. insights sku_ id"
        default: ""
      containsAll:
        description: "âœ… PATH contains ALL (AND). e.g. /en/ /insights/"
        default: ""
      exclude:
        description: "ðŸš« Exclude prefixes. e.g. /blog/ /news/"
        default: ""
      includeRe:
        description: "ðŸ”¬ Include regex (PATH)"
        default: ""
      excludeRe:
        description: "ðŸ”¬ Exclude regex (PATH)"
        default: ""
      allowSubdomains:
        description: "ðŸŒ Allow subdomains of base host?"
        type: choice
        options: ["false","true"]
        default: "false"
      allowHosts:
        description: "ðŸŒ Extra hosts (space/comma/newline)"
        default: ""
      hostRe:
        description: "ðŸ§ª Host allow regex"
        default: ""
      skipValidate:
        description: "âš¡ Skip HTTP validation"
        type: choice
        options: ["false","true"]
        default: "false"
      concurrency:
        description: "ðŸš¦ Concurrency"
        default: "8"
      maxSitemaps:
        description: "ðŸ§± Max sitemap files"
        default: "1000"
      outFile:
        description: "ðŸ“„ Output filename"
        default: "TestURL.js"

jobs:
  setup-and-execute:
    runs-on: ubuntu-22.04
    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§ª Validate Inputs & Export Env
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;34mðŸ” Validating Inputs...\033[0m"

          runType="${{ github.event.inputs.runType }}"
          sitemapMode="${{ github.event.inputs.sitemapMode }}"
          cssMode="${{ github.event.inputs.cssMode }}"
          baseUrl="${{ github.event.inputs.baseUrl }}"
          selector="${{ github.event.inputs.selector }}"
          rawInput="${{ github.event.inputs.rawInput }}"

          # Map to internal MODE your runners use
          MODE=""
          if [[ "$runType" == "sitemap" ]]; then
            MODE="1"
          else
            case "$cssMode" in
              "1") MODE="5" ;;  # auto â†’ anchors (fallback)
              "2") MODE="2" ;;  # CSS
              "3") MODE="3" ;;  # XPath
              "4") MODE="4" ;;  # Raw
              "5") MODE="5" ;;  # Anchors
              *) echo "âŒ Invalid cssMode: $cssMode"; exit 1;;
            esac
          fi

          # Validate requireds
          if [[ "$MODE" == "1" && -z "$baseUrl" ]]; then echo "âŒ baseUrl required for sitemap"; exit 1; fi
          if [[ "$MODE" =~ ^(2|3|5)$ && -z "$baseUrl" ]]; then echo "âŒ baseUrl required for cssMode $cssMode"; exit 1; fi
          if [[ "$MODE" == "2" && -z "$selector" ]]; then echo "âŒ CSS selector required (cssMode=2)"; exit 1; fi
          if [[ "$MODE" == "3" && -z "$selector" ]]; then echo "âŒ XPath selector required (cssMode=3)"; exit 1; fi
          if [[ "$MODE" == "4" && -z "$rawInput" ]]; then echo "âŒ rawInput required (cssMode=4)"; exit 1; fi

          # Export core env
          {
            echo "RUN_TYPE=$runType"
            echo "SITEMAP_MODE=$sitemapMode"
            echo "CSS_MODE=$cssMode"
            echo "MODE=$MODE"
            echo "BASE_URL=$baseUrl"
            echo "SELECTOR=$selector"
            echo "RAW_INPUT=$rawInput"
            echo "TESTFILES_LIST=$rawInput"
            # Sitemap knobs
            echo "SITEMAP_PRESET=${{ github.event.inputs.sitemapPreset }}"
            echo "TARGET_TOTAL=${{ github.event.inputs.targetTotal }}"
            echo "PER_GROUP=${{ github.event.inputs.perGroup }}"
            echo "START_WITH=${{ github.event.inputs.startWith }}"
            echo "CONTAINS_ANY=${{ github.event.inputs.containsAny }}"
            echo "CONTAINS_ALL=${{ github.event.inputs.containsAll }}"
            echo "EXCLUDE=${{ github.event.inputs.exclude }}"
            echo "INCLUDE_RE=${{ github.event.inputs.includeRe }}"
            echo "EXCLUDE_RE=${{ github.event.inputs.excludeRe }}"
            echo "ALLOW_SUBDOMAINS=${{ github.event.inputs.allowSubdomains }}"
            echo "ALLOW_HOSTS=${{ github.event.inputs.allowHosts }}"
            echo "HOST_RE=${{ github.event.inputs.hostRe }}"
            # Perf + out
            echo "SKIP_VALIDATE=${{ github.event.inputs.skipValidate }}"
            echo "CONCURRENCY=${{ github.event.inputs.concurrency }}"
            echo "MAX_SITEMAPS=${{ github.event.inputs.maxSitemaps }}"
            echo "OUT_FILE=${{ github.event.inputs.outFile }}"
            # Meta
            echo "PROJECT_NAME=${{ github.event.inputs.projectName }}"
            echo "CLIENT=${{ github.event.inputs.client }}"
            echo "PROJECT_MANAGER=${{ github.event.inputs.projectManager }}"
            echo "QA_MANAGER=${{ github.event.inputs.qaManager }}"
            echo "EXPECTED_LOAD_TIME=${{ github.event.inputs.expectedLoadTime }}"
          } >> "$GITHUB_ENV"

          echo -e "\033[1;32mâœ… Inputs OK.\033[0m"
          echo "ðŸ§­ runType=$runType | MODE=$MODE"
          echo "ðŸŒ baseUrl=$baseUrl"
          echo "ðŸŽ¯ selector=$selector"
          echo "cssMode=$cssMode | sitemapMode=$sitemapMode"

      - name: ðŸ“¦ Install Puppeteer for CSS/XPath/Anchors
        if: ${{ env.MODE == '2' || env.MODE == '3' || env.MODE == '5' }}
        run: npm i puppeteer

      - name: ðŸ”§ Prepare URL List
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;34mðŸ”§ Building URL list...\033[0m"

          if [[ "$MODE" == "4" ]]; then
            # Raw list
            echo "$RAW_INPUT" | tr ' ' '\n' > urlList.txt
            node -e 'const fs=require("fs");const u=String(process.env.RAW_INPUT||"").split(/[ \n]+/).filter(Boolean);fs.writeFileSync("TestURL.js","exports.urls = "+JSON.stringify(u,null,2)+";\\n")'
            test -f TestURL.js && echo "âœ… TestURL.js from raw input" || (echo "âŒ TestURL.js missing" && exit 1)

          elif [[ "$MODE" == "1" ]]; then
            # Sitemap (new helper)
            node core/sitemapUrlBuilder.js
            if [[ "$OUT_FILE" != "TestURL.js" && -f "$OUT_FILE" ]]; then cp "$OUT_FILE" TestURL.js; fi
            test -f "${OUT_FILE}" && echo "âœ… ${OUT_FILE} found" || (echo "âŒ ${OUT_FILE} missing" && exit 1)

          else
            # Your OLD builder for CSS/XPath/Anchors
            node core/githubTestUrlBuilder.js
            test -f TestURL.js && echo "âœ… TestURL.js found" || (echo "âŒ TestURL.js missing" && exit 1)
          fi

      - name: ðŸš€ Run Lighthouse Tests
        shell: bash
        run: |
          set -euo pipefail
          echo -e "\033[1;36mðŸ“¡ Starting Lighthouse...\033[0m"
          if [[ "$MODE" == "4" ]]; then
            echo -e "\033[1;33mðŸ”— Raw list (MODE=4) â€” executeGithub.js\033[0m"
            node executeGithub.js
          else
            echo -e "\033[1;34mðŸ§  MODE $MODE â€” runLighthouseAuto.js (reads TestURL.js)\033[0m"
            node runLighthouseAuto.js
          fi
          echo -e "\033[1;32mâœ… Lighthouse complete.\033[0m"

      - name: â³ Wait for Reports
        run: |
          echo -e "âŒ› Sleeping 40s to allow report generation..."
          sleep 40

      - name: ðŸ“‚ Move Reports to Reports_QA
        run: |
          mkdir -p ./Reports_QA
          mv *.html ./Reports_QA/ 2>/dev/null || true
          mv *.pdf ./Reports_QA/ 2>/dev/null || true
          mv ./results/*.csv ./Reports_QA/ 2>/dev/null || true
          echo -e "\033[1;32mâœ… Reports moved to Reports_QA\033[0m"

      - name: ðŸ“¤ Upload Reports as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-csv-html-reports
          path: ./Reports_QA/*

      - name: ðŸ“¦ Upload Lighthouse Full Results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-full-results
          path: ./.lighthouseci/*
